async function evalMove(e,t,n){if(0<e.bd[t])return{mv:t,sc:-99999};let a=m_gs(e.p[1],e.p[1],e);e=a.p[a.tn%2?1:0].pp;if(a.move(t),e.d>n)return{mv:t,sc:(await chooseMove(a,n+1)).sc};let l=100*a.sc.p1-100*a.sc.p2;return 6<a.sc.p1&&(l+=1e4),6<a.sc.p2&&(l-=1e4),a.ls.forEach(e=>{1==e.open&&(l+=e.p1-e.p2)}),l+=Math.random()*e.rn-Math.random()*e.rn,{mv:t,sc:l}}async function chooseMove(n,a){let l=n.tn%2?1:-1;await wait(1);let e=await Promise.all(n.bd.map((e,t)=>evalMove(n,t,a)));return e=e.filter(e=>-99999!=e.sc).sort((e,t)=>(e.sc-t.sc)*l),e[0]}async function aiPlay(e){return(await chooseMove(e,1)).mv}var _audC=new(window.AudioContext||window.webkitAudioContext),_aud_MV=1;function tone(t,e){if(!_audC||!_aud_MV)return{f:function(){return this},v:function(){return this}};var n=_audC.currentTime,a=_audC.createOscillator(),l=_audC.createGain();return e&&(a.type=e),a.frequency.value=0,l.gain.value=0,a.connect(l),l.connect(_audC.destination),a.start(0),a.stop(n+t),{f:function(){if(1==arguments.length)return a.frequency.value=arguments[0],this;for(var e=0;e<arguments.length;e+=1)a.frequency.linearRampToValueAtTime(arguments[e],n+e/(arguments.length-1)*t);return this},v:function(){if(1==arguments.length)return l.gain.value=arguments[0]*_aud_MV,this;for(var e=0;e<arguments.length;e+=1)l.gain.linearRampToValueAtTime(arguments[e]*_aud_MV,n+e/(arguments.length-1)*t);return this}}}var ae={score:()=>{tone(2).f(120,420).v(0,.3),tone(2).f(220,420).v(0,.5),tone(2).f(320,420).v(0,.3)},place:()=>{tone(.9,"square").f(100,200,50,50).v(.1,.3,0,0,.1,.05,0)},clk:()=>{tone(.1,"triangle").f(200,220,200).v(.1,.3,0),tone(.1,"triangle").f(220,200,220).v(.3,.1,0)}};function m_bd(a){bdSpts=new Array(64),ge("p1n").textContent=a.p[0].n,ge("p2n").textContent=a.p[1].n,ge("gamebrd").textContent="";let n=[];for(t=0;t<4;t+=1){var e=clone("gamebrd","brdlev");for(j=0;j<16;j+=1)bdSpts[16*t+j]=cloneIn(e,"brdspot","*");n.push(e)}setTimeout(()=>{[20,35,52,72].forEach((e,t)=>n[t].style.top=e+"vh")},10);for(var t=0;t<2;t+=1)clone("gamebrd","brdlevd").classList.toggle("x"+t,!0);return{setB:(e,t,n)=>{ge("bantxt").textContent=e,ge("bantxts").textContent=t,ge("bantxth").classList.toggle("big",!!n)},update:()=>{for(var e=0;e<64;e+=1)bdSpts[e].classList.toggle("p1",1==a.bd[e]),bdSpts[e].classList.toggle("p2",2==a.bd[e]),bdSpts[e].classList.toggle("sel",!1),bdSpts[e].classList.toggle("fl",!1),bdSpts[e].classList.toggle("high",e==a.lastmv);ge("p1s").textContent=a.sc.p1,ge("p2s").textContent=a.sc.p2},selMove:async()=>new Promise((t,e)=>{for(var n=0;n<64;n+=1)(e=>{bdSpts[e].classList.toggle("sel",0==a.bd[e]),bdSpts[e].onclick=()=>{t(e)}})(n)}),flashLine:e=>{allLines[e].forEach((e,t)=>{console.log("setting fl on "+e),bdSpts[e].style.setProperty("--off",.25*t+"s"),bdSpts[e].classList.toggle("fl",!0)})}}}async function selTurn(e,t,n,a){switch(n.t){case"l":return t.setB("Your turn  "+n.n,e.tn<6?"Select a spot to play":e.sc.av+" scoring opportunities left"),t.selMove();case"r":return t.setB("Waiting for "+n.n+" to play..."),new Promise((t,e)=>{lobby.waitMsg(e=>t(e.move))});case"a":return t.setB(n.n+" is thinking..."),aiPlay(e)}}async function pubTurn(e,t,n,a){"r"==n.t&&lobby.msg({move:a})}async function startGame(e,t){ge_gone("lobby",!0),ge_gone("game",!1);let a=m_gs(e,t),l=m_bd(a);l.setB("Starting Game","",!0),await wait(3e3);for(;await(async()=>{var e=a.tn%2;l.update();var t=await selTurn(a,l,a.p[e],e);await pubTurn(a,e?0:1,a.p[e?0:1],t),a.move(t),l.update(),l.setB(a.p[e].n+" has played."),ae.place(),await wait(1e3);let n=a.lastSLs();return n.length&&(l.setB(a.p[e].n+" Scored."),n.forEach(e=>l.flashLine(e)),ae.score(),await wait(2e3)),!(0==a.sc.av||7<=a.sc.p1||7<=a.sc.p2)})(););a.sc.p1==a.sc.p2?l.setB("DRAW!"):a.sc.p1>a.sc.p2?l.setB(a.p[0].n+" Wins",a.p[1].pp?.lose?a.p[1].pp.lose:"",!0):l.setB(a.p[1].n+" Wins","",!0),await wait(1e4),lobby.reset()}function m_gs(e,t,n){return{tn:n?n.tn:0,p:[{...e},{...t}],bd:n?[...n.bd]:new Array(64).fill(0),ls:new Array(allLines.length),lastmv:-1,sc:{p1:0,p2:0,av:0},move:function(e){this.bd[e]=this.tn%2?2:1,this.lastmv=e,this.analysis(),this.tn+=1},analysis:function(){this.sc.p1=this.sc.p2=this.sc.av=0,allLines.forEach((e,t)=>{this.ls[t]={p1:0,p2:0,scored:0,open:!0},e.forEach(e=>{1==this.bd[e]&&(this.ls[t].p1+=1),2==this.bd[e]&&(this.ls[t].p2+=1)}),4==this.ls[t].p1&&(this.ls[t].scored=1,this.ls[t].open=!1,this.sc.p1+=1),4==this.ls[t].p2&&(this.ls[t].scored=2,this.ls[t].open=!1,this.sc.p2+=1),0<this.ls[t].p1&&0<this.ls[t].p2&&(this.ls[t].open=!1),this.ls[t].open&&(this.sc.av+=1)})},lastSLs:function(){let n=[];return this.ls.forEach((e,t)=>{e.scored&&allLines[t].includes(this.lastmv)&&n.push(t)}),n}}}mkL=(e,t,n,l,o,s)=>{var r=[0,1,2,3];xl=null==e?r:[e],yl=null==t?r:[t],zl=null==n?r:[n];var i=[];return xl.forEach(a=>yl.forEach(n=>zl.forEach(t=>{i.push(r.map(e=>a+l*e+4*(n+o*e)+16*(t+s*e)))}))),i};var allLines=[...mkL(0,null,null,1,0,0),...mkL(null,0,null,0,1,0),...mkL(null,null,0,0,0,1),...mkL(0,0,null,1,1,0),...mkL(3,0,null,-1,1,0),...mkL(0,null,0,1,0,1),...mkL(3,null,0,-1,0,1),...mkL(null,0,0,0,1,1),...mkL(null,3,0,0,-1,1),...mkL(0,0,0,1,1,1),...mkL(3,0,0,-1,1,1),...mkL(3,3,0,-1,-1,1),...mkL(0,3,0,1,-1,1)];function _init_lobby(){let e=null,n=null;let a=null;try{a=io({upgrade:!1,transports:["websocket"]}),a.on("connect",()=>{}),a.on("lobby",e=>{let t=e.available.filter(e=>e.nick!=ge("nick").value).map(e=>({t:"Play with "+e.nick,lt:"Play online with this player",u:e,em:"🔗"}));t.length||(t=[{t:"No opponent",lt:"There are no others players in the lobby right now.",em:"😞"}]),menu("Player vs Player Online: Select Opponent",!0,t,(e,t)=>{a.emit("reqstart",{opponent:e.u.id})})}),a.on("disconnect",()=>{}),a.on("gm",e=>{let t=n;n=null,t&&t(e)}),a.on("playstart",e=>{var t={n:e.op,t:"r"},n={n:ge("nick").value,t:"l"};e.lead?startGame(n,t):startGame(t,n)}),a.on("playend",()=>{gamedone()}),a.on("error",()=>{})}catch(e){}geclk("bck",()=>{ae.clk(),leave_mp()}),geclk("nxt",()=>{ae.clk(),reset(),document.documentElement.requestFullscreen()}),menu=(e,t,n,a)=>{ge("menu").innerHTML="",ge_gone("top",!1),ge_qs("bot","legend").textContent=e,n.forEach((e,t)=>{let n=clone("menu","menui");qs_txt(n,"h1",e.em),qs_txt(n,"h2",e.t),qs_txt(n,"h3",e.lt),n.onclick=()=>{ae.clk(),a(e,t)}}),ge_gone("bck",!t),ge_gone("nxt",!0)},display=(e,t)=>{ge_gone("lobby",!1),ge_gone("game",!0),ge_gone("top",!0),ge("menu").innerHTML="",ge_qs("bot","legend").textContent=e;let n=clone("menu","displayi");n.innerHTML=t,ge_gone("bck",!0),ge_gone("nxt",!1)};let l=()=>{a.emit("el",{nick:ge("nick").value}),ge_no("top",!0)};return leave_mp=()=>{a&&a.emit("ll",{}),ge_no("top",!1),reset()},gamedone=()=>{e&&a.emit("reqend"),document.body.classList.toggle("ms",!0)},reset=()=>{ge_gone("lobby",!1),ge_gone("game",!0),menu("",!1,m_main,(e,t)=>{switch(t){case 0:display("The Rules of 𝟜-Play",gameRules);break;case 1:menu("Choose your opponent",!0,m_ais,(e,t)=>{p1={n:ge("nick").value,t:"l"},p2={n:e.t,t:"a",pp:e.pp},startGame(p1,p2)});break;case 2:p1={n:ge("nick").value,t:"l"},p2={n:"Player 2",t:"l"},startGame(p1,p2);break;case 3:l()}})},{waitMsg:e=>{n=e},msg:e=>{a.emit("gm",e)},menu:menu,display:display,enter_mp:l,reset:reset,gamedone:gamedone}}var lobby=null;function start_lobby(){lobby=lobby||_init_lobby(),ge("nick").value=oneof(["Alex","Storm","Petra","Zena","Xeno","Yuman","Jyn","Raith"])+oneof([" ⨊ "," ∐ "," § "," ∞ "," ⌘ "," ★ ","-","de","a"])+oneof(["Xi","Gen","My","Ti","Xi"]),lobby.display("",introText)}function init(){start_lobby(),p1={n:"Player 1",t:"l"},p2={n:"Player 2",t:"l"}}let m_main=[{t:"The Devil's Rules",em:"🎓",lt:"Learn the simple rules of 𝟜-Play"},{t:"The Minions of Hell",em:"⛧",lt:"Practice against various demonic opponents"},{t:"Two Players Local",em:"🎎",lt:"Practice against a human on one device"},{t:"Two Players Online",em:"🌐",lt:"Practice against a human online"}],m_ais=[{t:"Servant Imp",em:"👿",lt:"A foolish little thing - stupid and careless",pp:{d:1,rn:40,lose:"Anyone can beat a servant imp!"}},{t:"Goblin Intellectual",em:"😈",lt:"A well trained player, but goblins aren't bright",pp:{d:1,rn:10,lose:"You're smarter than a goblin; so what?"}},{t:"Vengence Demon",em:"👺",lt:"Plays well but easy to trick.",pp:{d:1,rn:1,lose:"You're getting the hang of this, maybe you can compete."}},{t:"Duke of Hell",em:"👹",lt:"Skilled and dangerous, very hard to beat",pp:{d:2,rn:10,lose:"Not many humans can beat me - perhaps you are the one!"}},{t:"Prince of Death",em:"☠",lt:"The famous expert of 𝟜-Play",pp:{d:2,rn:1,lose:"The prince rages and swears never to play the game again."}},{t:"Satan Lord of Hell",em:"✪",lt:"Never beaten by a Mortal",pp:{d:3,pm:1,opm:1,rn:.01,lose:"Your soul is saved from the ravages of hell - you have beaten the devil himself."}}],gameRules="It's tic-tac-toe. Everyone knows how to play tic-tac-toe, right?\n\nExcept...\n\nIt's played on a 3D 4 x 4 x 4 cubic grid.\n\nOn your turn make your mark on any open square. Place 4 markers in a straight line to score a point.The first player to reach 7 points wins.\nGood Luck!\n\n\nA hint to give you hope:\nMarkers can form a straight line in any direction - vertically, horizontally and diagonally across each board and through the boards.\nPractice against the lesser demons to steal their tricks!",introText="👤: Where am I?\n\n👺: You're dead.\n\n👤: What?!! It's quite warm here.\n\n👺: Yes. You're in Hell. Deal with it.\n The good news is that you've been bad but not very bad. Your soul is in the balance. You have 1 chance to save yourself. Beat the Devil at the game of your choice and you're free.\n We'll even let you practice first.\n\n👤: What?! Any game? I  choose tic-tac-toe but only if I can play the first turn.\n\n👺: Ooh, good choice! We have a version of that - we call it 𝟜-Play. It's just like tic-tac-toe, and you can go first if you think that will help\n\n👺: Perhaps you will be the first to beat the devil himself.\n",ge=e=>document.getElementById(e),gecl=(e,t,n)=>ge(e).classList.toggle(t,n),geclk=(e,t)=>ge(e).onclick=t,ge_gone=(e,t)=>gecl(e,"gone",t),ge_no=(e,t)=>gecl(e,"no",t),cloneIn=(e,t,n)=>{n=document.querySelector("#"+t).content.querySelector(n).cloneNode(!0);return e.appendChild(n),n},clone=(e,t)=>cloneIn(ge(e),t,"*"),cloneSP=(e,t,n)=>{let a=cloneIn(ge(e),t,"*");return Object.keys(n).forEach(e=>a.style.setProperty(e,n[e])),a},ge_qs=(e,t)=>ge(e).querySelector(t),qs_txt=(e,t,n)=>e.querySelector(t).textContent=n,oneof=e=>Array.isArray(e)?e[Math.floor(Math.random()*e.length)]:e,wait=t=>new Promise(e=>setTimeout(e,t));